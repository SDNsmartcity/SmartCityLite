<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCityLite v3 | Global Digital Twin</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
    
    <!-- Mapbox Geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000508; color: #e2e8f0; font-family: 'Space Grotesk', sans-serif; }
        
        #map-container { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI Layer */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .pointer-events-auto { pointer-events: auto; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(8, 12, 20, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(152, 247, 195, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }
        
        .glass-button {
            background: rgba(152, 247, 195, 0.05);
            border: 1px solid rgba(152, 247, 195, 0.2);
            transition: all 0.3s ease;
        }
        .glass-button:hover {
            background: rgba(152, 247, 195, 0.15);
            border-color: rgba(152, 247, 195, 0.5);
            box-shadow: 0 0 15px rgba(152, 247, 195, 0.2);
        }
        .glass-button.active {
            background: rgba(152, 247, 195, 0.2);
            border-color: #98f7c3;
            color: #98f7c3;
            box-shadow: 0 0 20px rgba(152, 247, 195, 0.3);
        }

        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; background: rgba(255,255,255,0.1);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px;
            border-radius: 50%; background: #98f7c3; margin-top: -5px;
            box-shadow: 0 0 10px rgba(152, 247, 195, 0.8); cursor: pointer;
        }

        /* Geocoder Customization */
        .mapboxgl-ctrl-geocoder {
            background-color: rgba(8, 12, 20, 0.9) !important;
            border: 1px solid rgba(152, 247, 195, 0.3);
            color: white !important;
            font-family: 'Space Grotesk', sans-serif;
            border-radius: 8px;
            width: 100%;
            max-width: 320px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .mapboxgl-ctrl-geocoder--input {
            color: white !important;
        }
        .mapboxgl-ctrl-geocoder--icon {
            fill: #98f7c3 !important;
        }
        .mapboxgl-ctrl-geocoder .suggestions {
            background-color: #0b101a !important;
            border: 1px solid rgba(152, 247, 195, 0.1);
        }
        .mapboxgl-ctrl-geocoder .suggestions > li > a {
            color: #ccc !important;
        }
        .mapboxgl-ctrl-geocoder .suggestions > li > a:hover {
            background-color: rgba(152, 247, 195, 0.1) !important;
        }

        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0; box-shadow: 0 0 0 0 rgba(152, 247, 195, 0.7); }
            50% { opacity: 1; box-shadow: 0 0 0 10px rgba(152, 247, 195, 0); }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .pulse-marker {
            width: 20px; height: 20px; background: #98f7c3; border-radius: 50%;
            position: relative; box-shadow: 0 0 15px #98f7c3;
        }
        .pulse-marker::after {
            content: ''; position: absolute; inset: -10px; border-radius: 50%;
            border: 2px solid #98f7c3; animation: pulse-ring 2s infinite;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .text-neon { color: #98f7c3; text-shadow: 0 0 8px rgba(152, 247, 195, 0.5); }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(152, 247, 195, 0.3); }
    </style>
</head>
<body>

    <div id="map-container"></div>

    <!-- UI Overlay -->
    <div id="ui-layer" class="flex flex-col justify-between p-4 md:p-6">
        
        <!-- Top Bar -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 w-full">
            <!-- Search -->
            <div id="geocoder-container" class="pointer-events-auto w-full md:w-auto z-50"></div>

            <!-- Quick Nav -->
            <div class="pointer-events-auto flex gap-2 overflow-x-auto max-w-full pb-1 md:pb-0 no-scrollbar">
                <button onclick="flyToCity('kl')" class="glass-button px-4 py-2 rounded-lg text-xs font-bold uppercase whitespace-nowrap text-white">Kuala Lumpur</button>
                <button onclick="flyToCity('nyc')" class="glass-button px-4 py-2 rounded-lg text-xs font-bold uppercase whitespace-nowrap text-white">New York</button>
                <button onclick="flyToCity('tokyo')" class="glass-button px-4 py-2 rounded-lg text-xs font-bold uppercase whitespace-nowrap text-white">Tokyo</button>
                <button onclick="flyToCity('london')" class="glass-button px-4 py-2 rounded-lg text-xs font-bold uppercase whitespace-nowrap text-white">London</button>
                <button onclick="flyToCity('dubai')" class="glass-button px-4 py-2 rounded-lg text-xs font-bold uppercase whitespace-nowrap text-white">Dubai</button>
            </div>

            <!-- Wallet Connect -->
            <button id="wallet-btn" onclick="toggleWallet()" class="pointer-events-auto glass-button px-5 py-2 rounded-lg flex items-center gap-2 group">
                <div class="w-2 h-2 rounded-full bg-gray-500 group-hover:bg-[#98f7c3] transition-colors" id="wallet-indicator"></div>
                <span class="text-xs font-bold uppercase tracking-wider text-white" id="wallet-text">Connect Wallet</span>
            </button>
        </div>

        <!-- Wallet Info Panel (Hidden by default) -->
        <div id="wallet-panel" class="absolute top-20 right-6 w-64 glass-panel rounded-xl p-4 hidden pointer-events-auto transform transition-all duration-300 translate-y-2 opacity-0">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                <span class="text-xs text-gray-400 font-bold uppercase">Account</span>
                <span class="text-[10px] font-mono text-neon">0x71C...9A21</span>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-300">City Nodes Owned</span>
                    <span class="font-mono text-sm font-bold text-white">3</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-300">Governance Power</span>
                    <span class="font-mono text-sm font-bold text-white">0.82%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-300">Network Status</span>
                    <span class="text-[10px] font-bold text-neon bg-[#98f7c3]/10 px-2 py-0.5 rounded">SYNCED</span>
                </div>
            </div>
        </div>

        <!-- Sidebar (Left) -->
        <aside class="pointer-events-auto w-full md:w-80 glass-panel rounded-2xl p-6 flex flex-col gap-6 mt-4 md:mt-0 max-h-[calc(100vh-100px)] overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center gap-3 border-b border-white/10 pb-4">
                <div class="w-8 h-8 bg-[#98f7c3] rounded flex items-center justify-center shadow-[0_0_15px_rgba(152,247,195,0.4)]">
                    <svg class="w-5 h-5 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-white tracking-wider glow-text leading-none">SMARTCITY<span class="font-light opacity-70">LITE</span></h1>
                    <div class="text-[9px] text-[#98f7c3] tracking-[0.3em] font-mono mt-1">GLOBAL DIGITAL TWIN</div>
                </div>
            </div>

            <!-- Modules -->
            <div class="space-y-6">
                
                <!-- Section 1: Standard Layers -->
                <div>
                    <h3 class="text-[9px] font-bold text-gray-500 tracking-[0.2em] mb-3 uppercase">Base Layers</h3>
                    <div class="space-y-2">
                        <button onclick="toggleLayer('urban-massing')" id="btn-urban-massing" class="glass-button active w-full p-3 rounded-lg flex justify-between items-center group">
                            <span class="text-xs font-bold text-white">Urban Massing (3D)</span>
                            <div class="w-1.5 h-1.5 rounded-full bg-[#98f7c3] shadow-[0_0_5px_#98f7c3]"></div>
                        </button>
                    </div>
                </div>

                <!-- Section 2: Smart City Data -->
                <div>
                    <h3 class="text-[9px] font-bold text-gray-500 tracking-[0.2em] mb-3 uppercase flex items-center gap-2">
                        Smart Data <span class="text-[8px] bg-blue-500/20 text-blue-300 px-1 rounded border border-blue-500/30">SIMULATION</span>
                    </h3>
                    <div class="space-y-2">
                        <button onclick="toggleLayer('energy-grid')" id="btn-energy-grid" class="glass-button w-full p-3 rounded-lg flex justify-between items-center group">
                            <span class="text-xs font-bold text-gray-400 group-hover:text-white transition-colors">Energy Grid Load</span>
                            <div class="status-dot w-1.5 h-1.5 rounded-full bg-white/20"></div>
                        </button>
                        <button onclick="toggleLayer('smart-pillars')" id="btn-smart-pillars" class="glass-button w-full p-3 rounded-lg flex justify-between items-center group">
                            <span class="text-xs font-bold text-gray-400 group-hover:text-white transition-colors">Pop. Density Pillars</span>
                            <div class="status-dot w-1.5 h-1.5 rounded-full bg-white/20"></div>
                        </button>
                    </div>
                </div>

                <!-- Section 3: Onchain -->
                <div>
                    <h3 class="text-[9px] font-bold text-gray-500 tracking-[0.2em] mb-3 uppercase flex items-center gap-2">
                        Onchain Layer <span class="text-[8px] bg-purple-500/20 text-purple-300 px-1 rounded border border-purple-500/30">DEMO</span>
                    </h3>
                    <div class="space-y-2">
                        <button onclick="toggleLayer('onchain-nodes')" id="btn-onchain-nodes" class="glass-button w-full p-3 rounded-lg flex justify-between items-center group">
                            <span class="text-xs font-bold text-gray-400 group-hover:text-white transition-colors">Network Nodes & Tx</span>
                            <div class="status-dot w-1.5 h-1.5 rounded-full bg-white/20"></div>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Time Cycle Footer -->
            <div class="mt-auto bg-black/40 p-4 rounded-xl border border-white/5">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-[9px] font-bold text-gray-400 tracking-widest">GLOBAL CLOCK</h3>
                    <span id="time-display" class="font-mono text-neon font-bold text-xs">12:00 UTC</span>
                </div>
                <input type="range" id="time-slider" min="0" max="23" value="12" step="1" oninput="updateTimeCycle(this.value)">
                <div class="flex justify-between mt-2 text-[8px] text-gray-600 font-bold uppercase">
                    <span>Night</span><span>Noon</span><span>Night</span>
                </div>
            </div>
        </aside>

    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#000508] transition-opacity duration-1000">
        <div class="relative">
            <div class="w-20 h-20 border-t-2 border-b-2 border-[#98f7c3] rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-10 h-10 bg-[#98f7c3] opacity-20 rounded-full animate-pulse"></div>
            </div>
        </div>
        <div class="mt-6 font-mono text-[#98f7c3] text-xs tracking-[0.3em] animate-pulse">ESTABLISHING UPLINK</div>
    </div>

    <script>
        // --- CONFIG ---
        const MAPBOX_TOKEN = xxx
        
        // --- LOCATIONS ---
        const CITIES = {
            'kl': { center: [101.7085, 3.1390], zoom: 13.5, pitch: 60, bearing: -20 },
            'nyc': { center: [-74.0060, 40.7128], zoom: 13, pitch: 55, bearing: 15 },
            'tokyo': { center: [139.7690, 35.6804], zoom: 13.5, pitch: 60, bearing: -45 },
            'london': { center: [-0.1276, 51.5074], zoom: 13, pitch: 50, bearing: 0 },
            'dubai': { center: [55.2708, 25.2048], zoom: 13, pitch: 60, bearing: -30 }
        };
        
        // --- MAJOR NODES (For Onchain Demo) ---
        const NODES = {
            "type": "FeatureCollection",
            "features": [
                { type: "Feature", geometry: { type: "Point", coordinates: [101.7085, 3.1390] }, properties: { name: "KUALA LUMPUR", tps: 4502 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [-74.0060, 40.7128] }, properties: { name: "NEW YORK", tps: 8210 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [139.7690, 35.6804] }, properties: { name: "TOKYO", tps: 6100 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [-0.1276, 51.5074] }, properties: { name: "LONDON", tps: 5400 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [55.2708, 25.2048] }, properties: { name: "DUBAI", tps: 3900 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [103.8198, 1.3521] }, properties: { name: "SINGAPORE", tps: 7200 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [12.4964, 41.9028] }, properties: { name: "ROME", tps: 2100 } },
                { type: "Feature", geometry: { type: "Point", coordinates: [-118.2437, 34.0522] }, properties: { name: "LOS ANGELES", tps: 4800 } }
            ]
        };

        // --- STATE ---
        let map;
        let activeLayers = {
            'urban-massing': true,
            'energy-grid': false,
            'smart-pillars': false,
            'onchain-nodes': false
        };
        let isWalletConnected = false;
        let timeCycle = 12;

        // --- INIT ---
        mapboxgl.accessToken = MAPBOX_TOKEN;
        
        map = new mapboxgl.Map({
            container: 'map-container',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [101.7085, 3.1390],
            zoom: 2, // Start global
            pitch: 0,
            bearing: 0,
            projection: 'globe', // V3 Global View
            antialias: true
        });

        // Search Bar
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            marker: false,
            placeholder: 'Search Global Network...',
            types: 'country,region,place,poi'
        });
        document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

        // --- MAP LOAD ---
        map.on('load', () => {
            // Hide Loader
            const loader = document.getElementById('loading-screen');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 1000);

            // Add Fog for atmosphere
            map.setFog({
                'range': [0.5, 10],
                'color': '#000508',
                'horizon-blend': 0.1,
                'high-color': '#111827',
                'space-color': '#000000',
                'star-intensity': 0.6
            });

            // Setup Layers
            setupBuildings();
            setupSmartData();
            setupOnchainLayer();

            // Initial Fly-in to KL
            setTimeout(() => {
                flyToCity('kl');
            }, 500);

            // Animation Loop
            requestAnimationFrame(animate);
        });

        // --- LAYER SETUP ---

        function setupBuildings() {
            // Standard 3D Buildings
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field'])?.id;

            map.addLayer({
                'id': 'urban-massing',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 12,
                'paint': {
                    'fill-extrusion-color': '#2d3748',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.8
                }
            }, labelLayerId);
        }

        function setupSmartData() {
            // 1. Smart Pillars Source (Empty initially)
            map.addSource('smart-pillars-source', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }
            });

            map.addLayer({
                id: 'smart-pillars-layer',
                type: 'fill-extrusion',
                source: 'smart-pillars-source',
                layout: { visibility: 'none' },
                paint: {
                    'fill-extrusion-color': [
                        'interpolate', ['linear'], ['get', 'value'],
                        0, '#0d9488',
                        1, '#98f7c3'
                    ],
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': 0,
                    'fill-extrusion-opacity': 0.9
                }
            });

            // Regenerate pillars on move end if active
            map.on('moveend', () => {
                if (activeLayers['smart-pillars']) generatePillars();
            });
        }

        function setupOnchainLayer() {
            // 1. Nodes
            map.addSource('onchain-nodes-source', {
                type: 'geojson',
                data: NODES
            });

            // Node Circle
            map.addLayer({
                id: 'onchain-nodes-circle',
                type: 'circle',
                source: 'onchain-nodes-source',
                layout: { visibility: 'none' },
                paint: {
                    'circle-radius': 6,
                    'circle-color': '#000000',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#98f7c3'
                }
            });

            // Node Label
            map.addLayer({
                id: 'onchain-nodes-label',
                type: 'symbol',
                source: 'onchain-nodes-source',
                layout: {
                    'visibility': 'none',
                    'text-field': ['get', 'name'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 10,
                    'text-offset': [0, 1.5],
                    'text-anchor': 'top'
                },
                paint: {
                    'text-color': '#98f7c3',
                    'text-halo-color': '#000000',
                    'text-halo-width': 2
                }
            });

            // 2. Transaction Lines (Great Circle Arcs)
            // Generate some random connections
            const lines = [];
            const coords = NODES.features.map(f => f.geometry.coordinates);
            
            for(let i=0; i<coords.length; i++) {
                // Connect to 2 random other nodes
                const target1 = coords[(i+1) % coords.length];
                const target2 = coords[(i+3) % coords.length];
                
                lines.push({ type: 'Feature', geometry: { type: 'LineString', coordinates: [coords[i], target1] } });
                lines.push({ type: 'Feature', geometry: { type: 'LineString', coordinates: [coords[i], target2] } });
            }

            map.addSource('onchain-lines-source', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: lines }
            });

            map.addLayer({
                id: 'onchain-lines-layer',
                type: 'line',
                source: 'onchain-lines-source',
                layout: { visibility: 'none', 'line-cap': 'round' },
                paint: {
                    'line-color': '#98f7c3',
                    'line-width': 1,
                    'line-opacity': 0.4,
                    'line-dasharray': [0, 4, 3] // Will animate dashoffset
                }
            });
        }

        // --- INTERACTION ---

        window.flyToCity = (key) => {
            const dest = CITIES[key];
            if (!dest) return;
            map.flyTo({
                center: dest.center,
                zoom: dest.zoom,
                pitch: dest.pitch,
                bearing: dest.bearing,
                speed: 0.8,
                curve: 1.2,
                essential: true
            });
        };

        window.toggleLayer = (id) => {
            activeLayers[id] = !activeLayers[id];
            const isActive = activeLayers[id];
            
            // UI Update
            const btn = document.getElementById(`btn-${id}`);
            const dot = btn.querySelector('.status-dot') || btn.querySelector('div:last-child'); // handle both types
            const text = btn.querySelector('span');

            if (isActive) {
                btn.classList.add('active');
                text.classList.remove('text-gray-400');
                text.classList.add('text-white');
                dot.classList.remove('bg-white/20');
                dot.classList.add('bg-[#98f7c3]', 'shadow-[0_0_5px_#98f7c3]');
            } else {
                btn.classList.remove('active');
                text.classList.add('text-gray-400');
                text.classList.remove('text-white');
                dot.classList.add('bg-white/20');
                dot.classList.remove('bg-[#98f7c3]', 'shadow-[0_0_5px_#98f7c3]');
            }

            // Layer Logic
            if (id === 'urban-massing') {
                map.setLayoutProperty('urban-massing', 'visibility', isActive ? 'visible' : 'none');
            }
            
            if (id === 'energy-grid') {
                // Toggle highlighting of existing road layer or create a filter
                // Simple: toggle global road visibility if strictly energy grid
                const layers = map.getStyle().layers;
                const roadLayers = layers.filter(l => l['source-layer'] === 'road');
                roadLayers.forEach(l => {
                    if (isActive) {
                        map.setPaintProperty(l.id, 'line-color', '#98f7c3');
                        map.setPaintProperty(l.id, 'line-opacity', 0.8);
                    } else {
                        // Reset to default dark style
                        map.setPaintProperty(l.id, 'line-color', '#334155');
                        map.setPaintProperty(l.id, 'line-opacity', 0.2);
                    }
                });
            }

            if (id === 'smart-pillars') {
                const visibility = isActive ? 'visible' : 'none';
                map.setLayoutProperty('smart-pillars-layer', 'visibility', visibility);
                if (isActive) generatePillars();
            }

            if (id === 'onchain-nodes') {
                const visibility = isActive ? 'visible' : 'none';
                map.setLayoutProperty('onchain-nodes-circle', 'visibility', visibility);
                map.setLayoutProperty('onchain-nodes-label', 'visibility', visibility);
                map.setLayoutProperty('onchain-lines-layer', 'visibility', visibility);
            }
        };

        window.toggleWallet = () => {
            isWalletConnected = !isWalletConnected;
            const btn = document.getElementById('wallet-btn');
            const ind = document.getElementById('wallet-indicator');
            const txt = document.getElementById('wallet-text');
            const panel = document.getElementById('wallet-panel');

            if (isWalletConnected) {
                btn.classList.add('border-[#98f7c3]', 'bg-[#98f7c3]/10');
                ind.classList.remove('bg-gray-500');
                ind.classList.add('bg-[#98f7c3]', 'shadow-[0_0_8px_#98f7c3]');
                txt.innerText = "0x71...9A21";
                txt.classList.add('text-[#98f7c3]');
                
                panel.classList.remove('hidden');
                setTimeout(() => {
                    panel.classList.remove('opacity-0', 'translate-y-2');
                }, 10);
            } else {
                btn.classList.remove('border-[#98f7c3]', 'bg-[#98f7c3]/10');
                ind.classList.add('bg-gray-500');
                ind.classList.remove('bg-[#98f7c3]', 'shadow-[0_0_8px_#98f7c3]');
                txt.innerText = "CONNECT WALLET";
                txt.classList.remove('text-[#98f7c3]');

                panel.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    panel.classList.add('hidden');
                }, 300);
            }
        };

        window.updateTimeCycle = (val) => {
            timeCycle = parseInt(val);
            document.getElementById('time-display').innerText = `${val.toString().padStart(2,'0')}:00 UTC`;
            
            // Update light
            const azimuth = (timeCycle - 12) * 15;
            const intensity = Math.max(0.15, Math.sin((timeCycle / 24) * Math.PI));
            map.setLight({
                anchor: 'viewport',
                color: '#ffffff',
                intensity: intensity,
                position: [1.5, azimuth, 45]
            });

            // Update Building Color (Day/Night)
            let color = '#2d3748'; // default night
            if (timeCycle >= 6 && timeCycle <= 18) {
                color = '#e2e8f0'; // day
            }
            if (map.getLayer('urban-massing')) {
                 map.setPaintProperty('urban-massing', 'fill-extrusion-color', [
                    'interpolate', ['linear'], ['get', 'height'],
                    0, timeCycle > 6 && timeCycle < 18 ? '#cbd5e1' : '#1e293b',
                    200, timeCycle > 6 && timeCycle < 18 ? '#ffffff' : '#98f7c3'
                ]);
            }
        };

        // --- ANIMATION & GENERATION ---

        let dashOffset = 0;
        function animate() {
            // Animate onchain lines
            if (activeLayers['onchain-nodes']) {
                dashOffset -= 0.2;
                map.setPaintProperty('onchain-lines-layer', 'line-dasharray', [0, 4, 3, dashOffset]);
            }

            // Animate energy grid (opacity pulse)
            if (activeLayers['energy-grid']) {
                const opacity = 0.5 + Math.sin(Date.now() / 1000) * 0.3;
                // We don't want to spam setPaintProperty too hard on all road layers, 
                // so we'll just do it on a key interval or keep it simple.
                // For performance, let's just leave it static bright green or use CSS-like logic if possible.
                // Actually, let's just update the specific layer we set earlier.
                // To save perf, we skip per-frame mapbox paint updates in this simple loop unless needed.
            }

            requestAnimationFrame(animate);
        }

        function generatePillars() {
            const center = map.getCenter();
            const pillars = [];
            const count = 40;
            const spread = 0.02; // degrees

            for (let i = 0; i < count; i++) {
                const lng = center.lng + (Math.random() - 0.5) * spread;
                const lat = center.lat + (Math.random() - 0.5) * spread;
                const height = Math.random() * 500 + 100;
                const value = Math.random();

                // Create a small square polygon
                const s = 0.0005;
                const poly = [
                    [lng - s, lat - s],
                    [lng + s, lat - s],
                    [lng + s, lat + s],
                    [lng - s, lat + s],
                    [lng - s, lat - s]
                ];

                pillars.push({
                    type: 'Feature',
                    properties: { height, value },
                    geometry: { type: 'Polygon', coordinates: [poly] }
                });
            }

            map.getSource('smart-pillars-source').setData({
                type: 'FeatureCollection',
                features: pillars
            });
        }

    </script>
</body>
</html>